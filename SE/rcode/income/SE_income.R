#Average monthly salary in the municipalities by region, sex, observations and year

# First PX file (2007-2024)
url1 <- "https://api.scb.se/ov0104/v2beta/api/v2/tables/TAB2003/data?lang=en&valueCodes[Region]=00,0114,0115,0117,0120,0123,0125,0126,0127,0128,0136,0138,0139,0140,0160,0162,0163,0180,0181,0182,0183,0184,0186,0187,0188,0191,0192,0305,0319,0330,0331,0360,0380,0381,0382,0428,0461,0480,0481,0482,0483,0484,0486,0488,0509,0512,0513,0560,0561,0562,0563,0580,0581,0582,0583,0584,0586,0604,0617,0642,0643,0662,0665,0680,0682,0683,0684,0685,0686,0687,0760,0761,0763,0764,0765,0767,0780,0781,0821,0834,0840,0860,0861,0862,0880,0881,0882,0883,0884,0885,0980,1060,1080,1081,1082,1083,1214,1230,1231,1233,1256,1257,1260,1261,1262,1263,1264,1265,1266,1267,1270,1272,1273,1275,1276,1277,1278,1280,1281,1282,1283,1284,1285,1286,1287,1290,1291,1292,1293,1315,1380,1381,1382,1383,1384,1401,1402,1407,1415,1419,1421,1427,1430,1435,1438,1439,1440,1441,1442,1443,1444,1445,1446,1447,1452,1460,1461,1462,1463,1465,1466,1470,1471,1472,1473,1480,1481,1482,1484,1485,1486,1487,1488,1489,1490,1491,1492,1493,1494,1495,1496,1497,1498,1499,1715,1730,1737,1760,1761,1762,1763,1764,1765,1766,1780,1781,1782,1783,1784,1785,1814,1860,1861,1862,1863,1864,1880,1881,1882,1883,1884,1885,1904,1907,1960,1961,1962,1980,1981,1982,1983,1984,2021,2023,2026,2029,2031,2034,2039,2061,2062,2080,2081,2082,2083,2084,2085,2101,2104,2121,2132,2161,2180,2181,2182,2183,2184,2260,2262,2280,2281,2282,2283,2284,2303,2305,2309,2313,2321,2326,2361,2380,2401,2403,2404,2409,2417,2418,2421,2422,2425,2460,2462,2463,2480,2481,2482,2505,2506,2510,2513,2514,2518,2521,2523,2560,2580,2581,2582,2583,2584,3000&valueCodes[Kon]=1,2,1%2B2&valueCodes[ContentsCode]=AM0106B3,AM0106B5&valueCodes[Tid]=2007,2008,2009,2010,2011,2012,2013,2014,2015,2016,2017,2018,2019,2020,2021,2022,2023,2024"

# Helper function to download and convert PX to data frame
download_px <- function(url) {
  px_file <- tempfile(fileext = ".px")
  download.file(url, px_file, mode = "wb")
  df <- as.data.frame(read.px(px_file))
  return(df)
}

# Download PX file
df_income <- download_px(url1)
# save
write.csv(
  df_income,
  file = file.path(source_income_path, "SE_income_13_24.csv"),
  row.names = FALSE
)


# Second query (Slovenia): Persons in employment by municipalities
url2 <- "https://pxweb.stat.si/SiStatData/api/v1/en/Data/0723405S.px"

# JSON body for POST request
body2 <- list(
  query = list(
    list(
      code = "OBČINA PREBIVALIŠČA",
      selection = list(
        filter = "item",
        values = list("0")
      )
    ),
    list(
      code = "SPOL",
      selection = list(
        filter = "item",
        values = list("0", "1", "2")
      )
    ),
    list(
      code = "OBČINA DELA",
      selection = list(
        filter = "item",
        values = c(
          "0","001","213","195","002","148","149","003","150","004","005","006","151","007",
          "008","009","152","011","012","013","014","153","196","015","016","017","018","019",
          "154","020","155","021","156","022","157","023","024","025","026","027","028","207",
          "029","030","031","158","032","159","160","161","162","034","035","036","037","038",
          "039","040","041","163","042","043","044","045","046","047","048","049","164","050",
          "197","165","051","052","053","166","054","055","056","057","058","059","060","061",
          "062","063","208","064","065","066","167","067","068","069","198","070","168","071",
          "072","073","074","169","075","212","170","076","199","077","078","079","080","081",
          "082","083","084","085","086","171","087","088","089","090","091","092","172","093",
          "200","173","094","174","095","175","096","097","098","099","100","101","102","103",
          "176","209","201","104","177","106","105","107","108","178","109","110","111","112",
          "113","114","179","180","202","115","203","181","204","182","116","210","205","033",
          "183","117","118","119","120","211","121","122","123","124","206","125","194","126",
          "127","184","010","128","129","130","185","186","131","132","133","187","134","188",
          "135","136","137","138","139","189","140","141","142","143","144","190","146","191",
          "147","192","193"
        )
      )
    )
  ),
  response = list(
    format = "json-stat"
  )
)

# POST request
res <- POST(url2, body = toJSON(body2, auto_unbox = TRUE), encode = "json")

# Check status
stop_for_status(res)

# Parse JSON-stat response
json_data <- content(res, as = "text")
parsed <- fromJSONstat(json_data)

# Convert to data frame
df_employment <- as.data.frame(parsed)

# Preview
head(df_employment)

# Rename columns
colnames(df_employment) <- c("residence", "gender", "year", "municipalities", "value")

df_employment <- df_employment %>%
  dplyr::select(-residence) %>%
  mutate(
    municipalities = stringr::str_replace_all(municipalities, " \\(workplace\\)| \\(delo\\)", "")
  ) %>%
  filter(municipalities != "SLOVENIA")


# Save to CSV
write.csv(
  df_employment,
  file = file.path(source_income_path, "SE_employment.csv"),
  row.names = FALSE
)